version: "3.8"

services:
  # Frontend - React aplikace
  frontend:
    image: "ghcr.io/nemovitostnik-h/droid-deploy:main"
    container_name: apk-manager-frontend
    restart: unless-stopped
    depends_on:
      - backend
      - postgres
    ports:
      - "${APP_PORT:-8580}:80"
    environment:
      - VITE_API_BASE_URL=${API_BASE_URL:-http://apk-manager-backend:3000/api}
      - TZ=${TZ:-Europe/Prague}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3
    networks:
      - apk-network
      - mediaservarr

  # Backend - Node.js API (ts-node runtime)
  backend:
    image: "ghcr.io/nemovitostnik-h/droid-deploy-backend:main"
    container_name: apk-manager-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${API_PORT:-3000}:3000"
    volumes:
      # APK adresáře - backend potřebuje read-write přístup
      - ${APK_DATA_PATH:-./data/apk}:/data/apk
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-apkmanager}:${POSTGRES_PASSWORD:-apkmanager}@apk-manager-db:5432/${POSTGRES_DB:-apkmanager}
      - JWT_SECRET=${JWT_SECRET:-change-this-secret-in-production}
      - JWT_EXPIRES_IN=24h
      - CORS_ORIGIN=*
      - APK_DIRECTORY=/data/apk/staging
      - PLATFORM_DEV=/data/apk/development
      - PLATFORM_RC=/data/apk/release-candidate
      - PLATFORM_PROD=/data/apk/production
      - TZ=${TZ:-Europe/Prague}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3
    networks:
      - apk-network
      - mediaservarr

  # Database - PostgreSQL
  postgres:
    image: postgres:16-alpine
    container_name: apk-manager-db
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-apkmanager}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-apkmanager}
      - POSTGRES_DB=${POSTGRES_DB:-apkmanager}
      - TZ=${TZ:-Europe/Prague}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-apkmanager}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - apk-network

volumes:
  postgres-data:
    driver: local

networks:
  apk-network:
    driver: bridge
  mediaservarr:
    external: true
